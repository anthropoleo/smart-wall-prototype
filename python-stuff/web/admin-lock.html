<!doctype html>
<!--
  LED Wall Controller admin unlock UI.

  Served by FastAPI (`python-stuff/server.py`) at `/admin` whenever a valid
  admin unlock token is not provided.
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LED Wall Admin Unlock</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <main class="wrap">
      <header class="header panel">
        <div class="brand-lockup">
          <img
            class="brand-logo"
            src="/static/assets/images/on-belay-logo.svg"
            alt="ON BELAY Climbing"
            decoding="async"
          />
          <div>
            <h1>LED Wall Controller</h1>
            <div class="mono">Admin unlock</div>
          </div>
        </div>
        <div class="header-actions">
          <a class="admin-link" href="/">Back to Dashboard</a>
          <a class="admin-link" href="/freestyle">Freestyle</a>
        </div>
      </header>

      <section class="panel controls-panel">
        <h2>Admin PIN required</h2>
        <div class="hint">
          Enter the PIN to open admin mode. You will be asked again the next time
          you open Admin Controls.
        </div>
        <form id="unlockForm" class="row">
          <label>
            Admin PIN
            <input
              id="adminPin"
              type="password"
              inputmode="numeric"
              maxlength="64"
              autocomplete="one-time-code"
              placeholder="Enter PIN"
            />
          </label>
          <button id="unlockBtn" type="submit">Unlock Admin</button>
        </form>
        <div class="status" id="unlockStatus">Locked</div>
      </section>
    </main>

    <script type="module">
      import { api } from "/static/api.js";

      window.__LED_ADMIN_TOKEN__ = "";

      const form = document.getElementById("unlockForm");
      const pinInput = document.getElementById("adminPin");
      const unlockBtn = document.getElementById("unlockBtn");
      const unlockStatus = document.getElementById("unlockStatus");

      function setStatus(text) {
        if (unlockStatus) unlockStatus.textContent = text;
      }

      form?.addEventListener("submit", async (event) => {
        event.preventDefault();
        const pin = pinInput?.value.trim() || "";
        if (!pin) {
          setStatus("PIN is required.");
          pinInput?.focus();
          return;
        }

        if (unlockBtn) unlockBtn.disabled = true;
        setStatus("Checking PIN...");
        try {
          const payload = await api("POST", "/api/admin/unlock", { pin });
          const token = typeof payload?.token === "string" ? payload.token : "";
          if (!token) {
            throw new Error("Unlock token missing.");
          }
          setStatus("Access granted. Opening admin mode...");
          window.location.replace(`/admin?token=${encodeURIComponent(token)}&ts=${Date.now()}`);
        } catch (error) {
          setStatus(`Access denied: ${error.message}`);
          pinInput?.select();
          pinInput?.focus();
        } finally {
          if (unlockBtn) unlockBtn.disabled = false;
        }
      });

      pinInput?.focus();
      setStatus("Enter admin PIN to continue.");
    </script>
  </body>
</html>
